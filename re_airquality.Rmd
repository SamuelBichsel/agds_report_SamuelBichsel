---
title: "Report Exercise Chapter 4"
author: "Samuel Bichsel"
output: html_document

---

## About this File

This Markdown file is for the report exercise entitled *Telling a story from data* which is part of Chapter 4 (Data visualisation) of the AGDS Course. The goal of this exercise is to explain and visualize the R dataset *airquality* with the help of various plots and statistical metrics.  

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning=FALSE, message=FALSE)
```

First, the libraries and functions used need to be setup. The functions were copied over from The Applied Geodata Science Book as well as everyones favourite website for this purpose - stackoverflow.com  
``` {r}
#library and functions setup 
airquality <- datasets::airquality

library(ggplot2)
library(dplyr)
library(tidyverse)
library(lubridate)



airquality <- airquality |>
  dplyr::mutate(
    date = make_date(day = Day, month = Month, year = 1973),
    Temp_C = (Temp - 32) * 5/9
  )


#function for running mean as taken from the book
running_mean <- function(
    vec,
    left,
    right
) {
  
  # Create an empty vector of the same length as the input data
  vec_out <- rep(NA, length(vec))
  
  # Loop over each position in the vector
  for (idx in (left+1):(length(vec)-right)){
    
    # Define start and end of the box to average over
    startbox <- idx - left
    endbox   <- idx + right
        
        vec_out[idx] <- mean(vec[startbox:endbox], na.rm = TRUE)
  }
  
  return(vec_out)
}


airquality <- airquality |>
  mutate(
    biweekly_Temp = running_mean(Temp_C, left = 7, right = 7),
    biweekly_Rad = running_mean(Solar.R, left = 7, right = 7)
  )


#function to put the equation for the linear regression as well as the R-Squared on graphic 3. Thank you StackOverflow 
eq <- function(x,y) {
  m <- lm(y ~ x);
 eq <- substitute(italic(y) == a + b %.% italic(x)*","~~italic(R)^2~"="~r2, 
         list(a = format(unname(coef(m)[1]), digits = 2),
              b = format(unname(coef(m)[2]), digits = 2),
             r2 = format(summary(m)$r.squared, digits = 3)))
    as.character(as.expression(eq));
}

```
## Data desciption and important patterns

#### Description of the data that includes at least three statistical metrics that are relevant for the problem (argue for why you chose these metrics).

The observed data here is about the daily air quality in the city of New York across 5 months from May to September in 1973. It includes variables about Ozone, Solar Radiation, Wind speeds and temperature.

The variables which are being analyzed here are the maximum daily Temperature and Solar Radiation. Note that the  Solar Radiation is given in Langleys (1 lan = 41'840 J/m2) and the Temperature is in Fahrenheit in the original dataset, but is transformed into Celsius in the Column Temp_C with (°F - 32) * 5/9. 

The most important and interesting metrics for the maximum daily Temperature are probably the mean, maximum, and minimum, though the dataset does crucially lack data on daily average or minimum daily temperatures. 
``` {r}
max(airquality$Temp_C)
min(airquality$Temp_C)
mean(airquality$Temp_C)
```


## Data visualisation 

#### At least three publishable figures that show important patterns (e.g., outliers, temporal patterns, scatterplots of correlations, etc.)

The visualization of the Daily Temperature and Solar Radiation evolution over the 5 months is made by using ggplot. The daily evolution, as well as a biweekly mean (which is calculated using the function for running mean from the AGDS book) is visible for both variables. 

``` {r}
#Filter the maximum and Minimum Temperature in the data frame so they can be put onto the plot as points
TempMax <- airquality %>%
  filter(Temp_C == max(Temp_C))
TempMin <- airquality %>%
  filter(Temp_C == min(Temp_C))




#1 trend of Temperature
ggplot(
  data = airquality,
  aes(x = date, y= Temp_C,)) +
  geom_line(aes(date, Temp_C, color = "Daily")) +
  geom_point() +
  geom_point(data = TempMax, color = "red", size = 1.3) + 
  geom_text(data = TempMax, label = round(TempMax$Temp_C, digits = 1), nudge_y = 0.9, size = 3) +
  geom_point(data = TempMin, color = "cyan1", size = 1.3) +
  geom_text(data = TempMin, label = round(TempMin$Temp_C, digits = 1), nudge_x = -5, size = 3) +
  labs(title = "Maximum Daily Temperature, 1973",
       subtitle = "LaGuardia Airport, New York, NY",
       x = "Month", 
       y = "Temperature (°C)"
  ) +
  
  geom_line(aes(date, biweekly_Temp, color = "Biweekly mean")) +
  
  scale_color_manual("",
                     values = c("purple", "black"),
                     labels = c("Biweekly mean", "Daily"))


#2 trend in solar radiation
ggplot(
  data = airquality,
  aes(x = date, y= Solar.R)) +
  geom_line(aes(date, Solar.R, color = "Daily")) +
  geom_point() +
  
  labs(title = "Solar radiation, 1973",
       subtitle = "Central Park, New York, NY",
       x = "Month", 
       y = "Radiation (lang)"
  ) +
  
  geom_line(
    aes(
      date, 
      biweekly_Rad
    )
  ) +
  geom_line(aes(date, biweekly_Rad, color = "Biweekly mean")) +
  
  scale_color_manual("",
                     values = c("orange1", "black"),
                     labels = c("Biweekly mean", "Daily"))
  
```

As can be seen, the Solar Radiation varies quite a bit more across and within the months than the Temperature. It is hard to see a specific trend for the Radiation, whereas the Temperature mostly follows the expected evolution of the seasons in the mid-latitudes with a warming in summer compared to the rest (except for a slight cooling in the latter part of June and a peak in temperatures in early september).

The two variables are expected to be somewhat positively correlated, as surface Temperature is, in part, dependent on the amount of solar radiation. One way to check for this is a correlation plot including a linear regression and a R-squared correlation coefficient. 

``` {r}
#3 Correlation plot 
ggplot(
  data = airquality,
  aes(x = Solar.R, y = Temp_C)) +
  geom_smooth(method = "lm", se = FALSE, color = "red") +
  geom_point() +
  labs(title = "Linear correlation Plot of Temperature and Solar Radiation",
       subtitle = "New York, NY (1973)",
       x = "Solar Radiation (lang)",
       y = "Temperature(°C)") + 
  geom_text(x = 172, y = 16.5, label = eq(airquality$Solar.R, airquality$Temp_C), parse = TRUE, size = 3.5)
  



```

As can be seen in the plot, using a linear regression to predict the dependent variable (Temperature) based on the independent Variable (Solar Radiation) does not really work, which can be seen both visually as well as through the low R-squared (less than 10% of the variation of the daily Temperature is explained by the solar Radiation). 


## Interpretation and discussion

#### Interpretation and discussion of your results and hypotheses. The text alone should not exceed one A4 page

The expectation that solar Radiation and Temperature should be closely correlated seems not to be the case in the observed data. This can be seen both visually on the graphs, as well as through the linear Regression with a low R-squared of 0.0761. 

There are multiple reasons why this could be: first of all it could be due to inconsistencies, the Solar Radiation is measured between 08:00 and 12:00, whereas the Temperature is for the whole day, as well as being only the maximum Temperature and not the average. Further, other local factors and weather conditions can influence daily Temperatures at the measuring station. 

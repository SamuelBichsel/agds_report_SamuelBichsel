---
title: "Report Exercise Chapter 3"
author: "Samuel Bichsel"
output: html_document
---

## About this file

This Markdown file is for the report exercise entitled *Cleaning data from elevated CO2 experiments* which is part of Chapter 3 (Data wrangling) of the AGDS Course. The goal is turning freely available, nice looking but untidy excel data from a scientific paper into a tidy dataset, and then aggregate said data and compute log-response ratios from it. The data used is from a paper by van Groenigen et al. about soil organic carbon measurements in experiments. The paper can be found at https://doi.org/10.1126/science.1249534. 



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning=FALSE, message=FALSE)
```
### Load packages

Load the packages that are needed (tidyverse and dplyr), and then read the csv file (note: read_delim had to be used instead of read_csv because excel decided to make the csv with semicolons instead of commas). 

```{r}
library(tidyverse)
library(dplyr)
Carbon <- readr::read_delim("./data/CarbonMeasurements.csv", delim = ";")
```

##  Step 2

#### In R, aggregate data per experiment and calculate the log-response ratio within each experiment.

In the first step, the CSV dataset with the various experiments which we are looking at got cleaned up and made easier to read and use in R.  

To calculate the log-response ratio (RR) for each experiment, take the logarithm of the mean soil organic carbon when exposed to 
increased CO2 divided by the same soil organic carbon when exposed to mean ambient (low) CO2. This log-response ratio is then appended to the table so each measurement has their respective treatment effect number in the column  "log-response ratio". 

These log-response ratios are then aggregated and averaged (taking the mean) by experiment with the functions "group_by" and "summarise" in a separate dataframe "Carbon_agg". As a last step a table is created with "knitr::kable"

```{r}
Xambient <- Carbon[,"mean ambient CO2"]
Xincreased <- Carbon[,"mean increased CO2"]
RR <- log(Xincreased/Xambient)

RR <- RR%>% rename("log-response ratio" = "mean increased CO2")

Carbon <- Carbon %>% add_column(RR)

Carbon_agg <- Carbon |>
  group_by(Experiment) |>
  summarise(`log-response ratio` = mean(`log-response ratio`))

knitr::kable(Carbon_agg, caption = "*Table 1: Log-response ratios of Carbon Measurements for all individual experiments*")

```
The log-response ratio in this case means that the more positive the value, the more of an effect higher ambient CO2 concentration has on soil organic carbon measurements. This means values close to zero or even negative indicate that for that experiment, a higher concentration of CO2 in the air doesn't influence/influences negatively the C concentration in the soil.  

## Step 3

#### Aggregate data across all experiments for different years since the start of the experiment, distinguishing an early phase (<3 years since start), a mid-phase (3-6 years since start), and a late phase (>6 years since start). Calculate the log-response ratio for each phase.

The aggregation by time period accross all experiments of every log-response ratio is done by first adding a new column representing the three time periods with the function "mutate" using 4 cuts, inbetween which the three time intervals are situated. Basically, every row is being assigned one of these three intervals based on the time the experiment has been running (which is given in the column "time(years)"), and the summarizing will be done based on these intervals.  

Note that for the cut at 3 years, the number 2.9 has been used, as otherwise it would include experiments that have been running for 3 years in the category "early phase", whereas it should be in the category "mid-phase". "include.lowest = TRUE" is also added, as otherwise it would disregard all the measurements done at time = 0 in all experiments. 

After that, just like before, the log-response ratios are aggregated using their mean, this time based on the cuts that were added.

```{r} 

Carbon_phases <-
  Carbon %>% mutate(phase = cut(`Time (years)`, c(0, 2.9, 6, Inf), labels = c("early phase", "mid-phase", "late phase"),   include.lowest = TRUE)) %>%
  group_by(phase) |>
  summarise(`log-response ratio` = mean(`log-response ratio`))

knitr::kable(Carbon_phases, caption = "*Table 2: Log-response ratios of Carbon Measurements for experiments aggregated by duration*")
```
Aggregation across experiment length seems to show that while in early and middle-phase the effect of increased CO2 in the atmosphere is positive on the carbon levels in the soil, this effect turns around when it comes to experiments running for 6 years or more.


Data source: Groenigen, Kees Jan van, Xuan Qi, Craig W. Osenberg, Yiqi Luo, and Bruce A. Hungate. “Faster Decomposition Under Increased Atmospheric CO2 Limits Soil Carbon Storage.” Science 344, no. 6183 (May 2, 2014): 508–9. https://doi.org/10.1126/science.1249534.
